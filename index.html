<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>DuckShop Â· Admin (Pro AI)</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f5f7fb; color: #1e293b; font-size: 15px; line-height: 1.5; }

        /* Login Screen */
        .login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(145deg, #3b82f6 0%, #8b5cf6 100%); padding: 1rem; }
        .login-box { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); width: 100%; max-width: 380px; padding: 2rem 1.5rem; border-radius: 28px; box-shadow: 0 20px 35px rgba(0,0,0,0.2); }
        .login-box h1 { font-size: 2rem; font-weight: 700; margin-bottom: 2rem; text-align: center; color: #1e293b; }
        
        .form-group { margin-bottom: 1.5rem; position: relative; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #334155; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 1rem; border: 1px solid #cbd5e1; border-radius: 18px; font-size: 1rem; background: white; transition: border 0.2s; }
        .form-group input:focus, .form-group textarea:focus { border-color: #3b82f6; outline: none; }
        
        /* AI Button Styles */
        .ai-btn { position: absolute; top: 0; right: 0; background: linear-gradient(135deg, #6366f1, #a855f7); color: white; border: none; padding: 0.3rem 0.8rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; box-shadow: 0 4px 10px rgba(168, 85, 247, 0.3); transition: transform 0.2s; }
        .ai-btn:hover { transform: scale(1.05); }
        .ai-loading { opacity: 0.7; pointer-events: none; }

        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 1rem 2rem; border: none; border-radius: 40px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.2s; background: #e2e8f0; color: #1e293b; width: 100%; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:active { background: #2563eb; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.9rem; width: auto; }

        /* Admin wrapper */
        .admin-wrapper { display: flex; flex-direction: column; height: 100vh; background: #f8fafc; position: relative; }
        .app-header { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.2rem; background: white; border-bottom: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.03); z-index: 20; }
        .menu-btn { background: none; border: none; font-size: 1.8rem; color: #3b82f6; cursor: pointer; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; }
        .app-header h1 { font-size: 1.5rem; font-weight: 700; color: #0f172a; }
        .header-placeholder { width: 48px; }

        /* Drawer */
        .drawer { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: white; box-shadow: 4px 0 20px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.25s ease; z-index: 100; padding: 2rem 1rem; display: flex; flex-direction: column; }
        .drawer.open { transform: translateX(0); }
        .drawer-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2.5rem; padding: 0 0.5rem; }
        .drawer-header h2 { font-size: 1.8rem; font-weight: 700; background: linear-gradient(145deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .close-drawer { background: none; border: none; font-size: 2rem; cursor: pointer; color: #64748b; }
        .drawer-nav { list-style: none; flex: 1; }
        .drawer-nav li { margin-bottom: 0.75rem; }
        .drawer-nav a { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.2rem; color: #334155; font-weight: 500; border-radius: 16px; text-decoration: none; font-size: 1.1rem; transition: background 0.2s; }
        .drawer-nav a i { width: 28px; font-size: 1.3rem; color: #3b82f6; }
        .drawer-nav a.active { background: #3b82f6; color: white; }
        .drawer-nav a.active i { color: white; }
        #logout-btn { display: flex; align-items: center; gap: 1rem; padding: 1rem 1.2rem; background: none; border: 1px solid #e2e8f0; border-radius: 20px; color: #ef4444; font-weight: 500; font-size: 1.1rem; cursor: pointer; margin-top: 1rem; width: 100%; }
        .drawer-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); opacity: 0; visibility: hidden; transition: 0.2s; z-index: 90; }
        .drawer-overlay.show { opacity: 1; visibility: visible; }

        /* Main content */
        .main-content { flex: 1; overflow-y: auto; padding: 1.2rem; -webkit-overflow-scrolling: touch; }
        .page { display: none; }
        .page.active { display: block; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: white; border-radius: 24px; padding: 1.2rem 1rem; box-shadow: 0 6px 14px rgba(0,0,0,0.03); border: 1px solid #e9eef2; display: flex; align-items: center; gap: 0.8rem; }
        .stat-icon { width: 52px; height: 52px; border-radius: 18px; background: #dbeafe; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; color: #3b82f6; }
        .stat-info h3 { font-size: 1.6rem; font-weight: 700; line-height: 1.2; color: #0f172a; }
        .stat-info p { font-size: 0.8rem; color: #64748b; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; }

        /* Lists */
        .content-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
        .content-header h2 { font-size: 1.6rem; font-weight: 700; color: #0f172a; }
        .btn-add { background: #3b82f6; color: white; border: none; width: 52px; height: 52px; border-radius: 30px; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(59,130,246,0.3); cursor: pointer; }
        
        .product-list, .category-list, .order-list { display: flex; flex-direction: column; gap: 1rem; }
        .product-card, .category-item { background: white; border-radius: 22px; padding: 1rem; border: 1px solid #edf2f7; display: flex; align-items: center; gap: 1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .product-img, .category-img { width: 70px; height: 70px; border-radius: 18px; object-fit: cover; background: #f1f5f9; }
        .product-details, .category-name { flex: 1; }
        .product-details h4 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.2rem; }
        .product-details .product-category { font-size: 0.8rem; color: #64748b; margin-bottom: 0.3rem; }
        .product-details .product-price { font-weight: 700; color: #3b82f6; }
        .actions-group { display: flex; gap: 0.5rem; }
        .actions-group button { width: 44px; height: 44px; border-radius: 18px; border: 1px solid #e2e8f0; background: white; font-size: 1.2rem; color: #334155; cursor: pointer; }
        .actions-group .btn-delete { color: #ef4444; }

        /* Toggle Switch */
        .toggle-container { display: flex; align-items: center; gap: 10px; margin: 1rem 0; background: #eff6ff; padding: 15px; border-radius: 12px; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(24px); }

        /* Sub Category Item Styles */
        .sub-cat-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        .sub-cat-item span { font-weight: 500; }
        .sub-cat-delete { color: #ef4444; background: none; border: none; font-size: 1.1rem; cursor: pointer; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: flex-end; justify-content: center; opacity: 0; visibility: hidden; transition: 0.2s; z-index: 200; }
        .modal.open { opacity: 1; visibility: visible; }
        .modal-content { background: white; width: 100%; max-height: 95vh; overflow-y: auto; border-top-left-radius: 30px; border-top-right-radius: 30px; padding: 2rem 1.5rem; transform: translateY(100%); transition: transform 0.25s; box-shadow: 0 -10px 30px rgba(0,0,0,0.2); }
        .modal.open .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .close-modal-btn { background: none; border: none; font-size: 2.2rem; cursor: pointer; color: #64748b; }

        /* FIXED IMAGE PREVIEW & DELETE BUTTON */
        .image-previews { display: flex; flex-wrap: wrap; gap: 0.8rem; margin: 1rem 0; }
        .preview-item { position: relative; width: 80px; height: 80px; border-radius: 18px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; }
        
        .delete-preview { 
            position: absolute; 
            top: 2px; 
            right: 2px; 
            background: rgba(239, 68, 68, 0.9); /* Red background */
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 24px; 
            height: 24px; 
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .delete-preview:active { transform: scale(0.9); }

        .toast { position: fixed; bottom: 30px; left: 20px; right: 20px; background: #1e293b; color: white; padding: 1rem; border-radius: 30px; text-align: center; font-weight: 500; opacity: 0; visibility: hidden; transition: 0.2s; z-index: 300; }
        .toast.show { opacity: 1; visibility: visible; }
        .d-none { display: none !important; }
        hr { margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0; }
        
        /* Updated Variant Styles */
        .variant-entry { display: flex; flex-direction: column; gap: 0.5rem; background: #f1f5f9; padding: 1.2rem; border-radius: 20px; margin-bottom: 1rem; border: 1px solid #e2e8f0; }
        .variant-entry input { margin-bottom: 0.5rem; background: white; }
        .remove-variant-btn { background: #fee2e2; border: none; padding: 0.8rem; border-radius: 18px; color: #ef4444; font-weight: 600; cursor: pointer; margin-top: 5px; width: 100%; }
        .remove-variant-btn:active { background: #fecaca; }
    </style>
</head>
<body>
    <!-- Login View -->
    <div id="login-view">
        <div class="login-container">
            <div class="login-box">
                <h1>ðŸ¦† DuckShop</h1>
                <form id="admin-code-form">
                    <div class="form-group">
                        <label for="admin-code">4-digit code</label>
                        <input type="password" id="admin-code" required maxlength="4" pattern="\d{4}" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢">
                    </div>
                    <button type="submit" class="btn btn-primary">Enter</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Mobile View -->
    <div id="admin-view" class="admin-wrapper d-none">
        <!-- Header -->
        <div class="app-header">
            <button class="menu-btn" id="menuToggle"><i class="fas fa-bars"></i></button>
            <h1 id="page-title">Dashboard</h1>
            <div class="header-placeholder"></div>
        </div>

        <!-- Drawer -->
        <div class="drawer" id="drawer">
            <div class="drawer-header">
                <h2>DuckShop</h2>
                <button class="close-drawer" id="closeDrawer"><i class="fas fa-times"></i></button>
            </div>
            <ul class="drawer-nav">
                <li><a href="#dashboard" class="nav-link active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#products" class="nav-link"><i class="fas fa-box"></i> Products</a></li>
                <li><a href="#categories" class="nav-link"><i class="fas fa-sitemap"></i> Categories</a></li>
                <li><a href="#sub-categories" class="nav-link"><i class="fas fa-layer-group"></i> Sub Categories</a></li>
                <li><a href="#orders" class="nav-link"><i class="fas fa-shopping-cart"></i> Orders</a></li>
                <li><a href="#discounts" class="nav-link"><i class="fas fa-tag"></i> Discounts</a></li>
            </ul>
            <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
        <div class="drawer-overlay" id="drawerOverlay"></div>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard -->
            <section id="dashboard-page" class="page active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-box"></i></div><div class="stat-info"><h3 id="total-products">0</h3><p>Products</p></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-sitemap"></i></div><div class="stat-info"><h3 id="total-categories">0</h3><p>Categories</p></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-shopping-cart"></i></div><div class="stat-info"><h3 id="total-orders">0</h3><p>Orders</p></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-rupee-sign"></i></div><div class="stat-info"><h3 id="total-revenue">â‚¹0</h3><p>Revenue</p></div></div>
                </div>
                <h3 class="section-title">Pending Orders</h3>
                <div id="pending-orders-list" class="order-list"></div>
            </section>

            <!-- Products -->
            <section id="products-page" class="page">
                <div class="content-header"><h2>Products</h2><button class="btn-add" id="add-product-btn"><i class="fas fa-plus"></i></button></div>
                <div id="products-list" class="product-list"></div>
            </section>

            <!-- Categories -->
            <section id="categories-page" class="page">
                <div class="content-header"><h2>Categories</h2><button class="btn-add" id="add-category-btn"><i class="fas fa-plus"></i></button></div>
                <div id="categories-list" class="category-list"></div>
            </section>

            <!-- Sub Categories -->
            <section id="sub-categories-page" class="page">
                <div class="content-header"><h2>Sub Categories</h2></div>
                <div style="background:white; padding:1.5rem; border-radius:24px; border:1px solid #e2e8f0;">
                    <div class="form-group">
                        <label for="manage-sub-cat-parent">Select Parent Category</label>
                        <select id="manage-sub-cat-parent"><option value="">Select Category</option></select>
                    </div>
                    
                    <div id="sub-cat-settings-area" class="d-none">
                        <div class="toggle-container">
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable-sub-cats-toggle">
                                <span class="slider"></span>
                            </label>
                            <span style="font-weight:600;">Enable Sub-categories</span>
                        </div>
                        <p style="font-size:0.85rem; color:#64748b; margin-bottom:1rem;">
                            If enabled, products in this category <b>must</b> have a sub-category selected. If disabled, sub-categories will be hidden.
                        </p>

                        <div id="sub-cat-creation-area" class="d-none">
                            <hr>
                            <h4 style="margin-bottom:10px;">Manage List</h4>
                            <div style="display:flex; gap:10px; margin-bottom:15px;">
                                <input type="text" id="new-sub-cat-input" placeholder="New Sub Category Name" style="flex:1; padding:0.8rem; border-radius:12px; border:1px solid #ccc;">
                                <button id="add-new-sub-cat-btn" class="btn btn-primary btn-sm">Add</button>
                            </div>
                            <div id="current-sub-cat-list"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Orders -->
            <section id="orders-page" class="page">
                <div class="content-header"><h2>Orders</h2></div>
                <div id="orders-list" class="orders-list"></div>
            </section>

            <!-- Discounts -->
            <section id="discounts-page" class="page">
                <div class="content-header"><h2>Discounts</h2><button class="btn-add" id="add-discount-btn"><i class="fas fa-plus"></i></button></div>
                <div id="discounts-list" class="discount-list"></div>
            </section>
        </main>

        <!-- Product Modal -->
        <div id="product-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-product-title">Add Product</h2>
                    <button class="close-modal-btn" data-target="#product-modal">&times;</button>
                </div>
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    
                    <div class="form-group">
                        <label for="product-category">Category</label>
                        <select id="product-category" required><option value="">Select</option></select>
                    </div>

                    <!-- DYNAMIC SUB CATEGORY SELECT -->
                    <div class="form-group d-none" id="product-sub-cat-group">
                        <label for="product-sub-category-select">Sub Category (Required)</label>
                        <select id="product-sub-category-select">
                            <option value="">Select Sub Category</option>
                        </select>
                    </div>

                    <!-- Veg/Non-Veg Tagging -->
                    <div class="form-group d-none" id="food-type-container">
                        <label for="product-food-type">Food Type</label>
                        <select id="product-food-type">
                            <option value="none">None</option>
                            <option value="veg">ðŸŸ¢ Veg</option>
                            <option value="non-veg">ðŸ”´ Non-Veg</option>
                        </select>
                    </div>

                    <!-- HIDDEN INPUT TO STORE URLS -->
                    <input type="hidden" id="product-image-urls-hidden" value="">
                    
                    <div class="form-group">
                        <label>Images</label>
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:5px;">
                            <input type="file" id="product-image-upload" accept="image/*" multiple style="width:70%;">
                            <button type="button" id="upload-product-images-btn" class="btn btn-primary" style="width:28%; padding:0.5rem; font-size:0.9rem;">Upload</button>
                        </div>
                        <div id="product-image-previews" class="image-previews"></div>
                        <!-- AI Image Analyze Button -->
                        <button type="button" id="ai-analyze-image-btn" class="btn" style="background: linear-gradient(135deg, #10b981, #3b82f6); color: white; margin-top: 5px; font-size: 0.9rem; padding: 0.6rem;">
                            <i class="fas fa-eye"></i> &nbsp; Analyze Image (Multiple)
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="product-name">Product Name</label>
                        <input type="text" id="product-name" required placeholder="Short & SEO friendly name">
                        <!-- AI Name/Desc Button -->
                        <button type="button" id="ai-generate-text-btn" class="ai-btn">
                            <i class="fas fa-magic"></i> AI Rewrite
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-description">Description</label>
                        <textarea id="product-description" rows="6" required placeholder="Detailed description..."></textarea>
                    </div>

                    <div class="form-check" style="display: flex; align-items: center; gap: 0.5rem; margin: 1rem 0; background: #eff6ff; padding: 10px; border-radius: 12px;">
                        <input type="checkbox" id="has-variants-checkbox" style="width: 20px; height: 20px;">
                        <label for="has-variants-checkbox" style="margin: 0; font-weight: 600;">Has variants (e.g., 500g, 1kg)</label>
                    </div>

                    <div id="simple-product-fields">
                        <div class="form-group">
                            <label for="product-price">Selling Price (â‚¹)</label>
                            <input type="number" id="product-price" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="product-original-price">Original Price (â‚¹)</label>
                            <input type="number" id="product-original-price" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="product-stock">Stock</label>
                            <input type="number" id="product-stock" min="0" required>
                        </div>
                    </div>

                    <div id="variant-product-fields" class="d-none">
                        <div id="variants-list"></div>
                        <button type="button" id="add-variant-btn" class="btn btn-primary" style="margin-top: 10px;">+ Add Variant</button>
                    </div>
                    <hr>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </form>
            </div>
        </div>

        <!-- Category Modal -->
        <div id="category-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-category-title">Add Category</h2>
                    <button class="close-modal-btn" data-target="#category-modal">&times;</button>
                </div>
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    <div class="form-group">
                        <label for="category-name">Category Name</label>
                        <input type="text" id="category-name" required>
                    </div>
                    <input type="hidden" id="category-image-hidden" value="">
                    <div class="form-group">
                        <label>Image</label>
                        <input type="file" id="category-image-upload" accept="image/*">
                        <button type="button" id="upload-category-image-btn" class="btn btn-primary btn-sm" style="margin-top:8px;">Upload</button>
                        <div id="category-image-preview" class="image-previews"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Category</button>
                </form>
            </div>
        </div>

        <!-- Other modals -->
        <div id="discount-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><h2>Add Discount</h2><button class="close-modal-btn" data-target="#discount-modal">&times;</button></div>
                <form id="discount-form">
                    <input type="hidden" id="discount-id">
                    <div class="form-group"><label>Code</label><input type="text" id="discount-code" required></div>
                    <div class="form-group"><label>Type</label><select id="discount-type" required><option value="percent">Percentage (%)</option><option value="fixed">Fixed (â‚¹)</option></select></div>
                    <div class="form-group"><label>Value</label><input type="number" id="discount-value" min="0" step="0.01" required></div>
                    <div class="form-group d-none" id="max-discount-group"><label>Max Discount (â‚¹)</label><input type="number" id="discount-max" min="0" step="0.01"></div>
                    <button type="submit" class="btn btn-primary">Save Discount</button>
                </form>
            </div>
        </div>

        <div id="order-details-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><h2>Order Details</h2><button class="close-modal-btn" data-target="#order-details-modal">&times;</button></div>
                <div id="order-details-content"></div>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove, get, update } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB7P6KPjrJXI2GBHvgRIj7-djZEb2itImQ",
          authDomain: "duckshop-2026.firebaseapp.com",
          databaseURL: "https://duckshop-2026-default-rtdb.firebaseio.com",
          projectId: "duckshop-2026",
          storageBucket: "duckshop-2026.firebasestorage.app",
          messagingSenderId: "707987638458",
          appId: "1:707987638458:web:014ceda971a863fbab9a83"
        };  
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- AI API CONFIGURATION ---
        const OPENROUTER_API_KEY = "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";
        const TEXT_MODEL = "arcee-ai/trinity-large-preview:free";
        const IMAGE_MODEL = "nvidia/nemotron-nano-12b-v2-vl:free";
        const IMGBB_API_KEY = '3d6e523beca3399d739ded007d03a61a';

        // UI Elements
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const drawer = document.getElementById('drawer');
        const menuToggle = document.getElementById('menuToggle');
        const closeDrawer = document.getElementById('closeDrawer');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const pageTitle = document.getElementById('page-title');

        let currentProducts = {}, currentOrders = {}, currentDiscounts = {}, currentCategories = {};
        
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount || 0);
        const formatDateTime = (ts) => ts ? new Date(ts).toLocaleString('en-IN', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }) : 'N/A';

        // --- LOGIN LOGIC ---
        document.getElementById('admin-code-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('admin-code').value;
            try {
                const snap = await get(ref(db, 'adminUsers'));
                if (snap.exists() && Object.values(snap.val()).some(u => u.code === code)) {
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    loginView.classList.add('d-none');
                    adminView.classList.remove('d-none');
                    initializeAppState();
                    handleRouting();
                } else showToast('Invalid code', 'error');
            } catch (err) { showToast('Login failed', 'error'); }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('isAdminLoggedIn');
            window.location.reload();
        });

        const checkLogin = () => {
            if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                loginView.classList.add('d-none');
                adminView.classList.remove('d-none');
                initializeAppState();
                handleRouting();
            }
        };
        window.addEventListener('load', checkLogin);

        // --- ROUTING & UI ---
        const handleRouting = () => {
            const hash = window.location.hash || '#dashboard';
            pages.forEach(p => p.classList.toggle('active', `#${p.id.replace('-page','')}` === hash));
            navLinks.forEach(l => l.classList.toggle('active', l.getAttribute('href') === hash));
            const activeLink = [...navLinks].find(l => l.getAttribute('href') === hash);
            if (activeLink) pageTitle.textContent = activeLink.textContent.trim();
            drawer.classList.remove('open');
            drawerOverlay.classList.remove('show');
        };
        window.addEventListener('hashchange', handleRouting);
        menuToggle.addEventListener('click', () => { drawer.classList.add('open'); drawerOverlay.classList.add('show'); });
        closeDrawer.addEventListener('click', () => { drawer.classList.remove('open'); drawerOverlay.classList.remove('show'); });
        drawerOverlay.addEventListener('click', () => { drawer.classList.remove('open'); drawerOverlay.classList.remove('show'); });

        // --- FIREBASE DATA HANDLING ---
        const listenToData = (path, cb) => onValue(ref(db, path), (s) => cb(s.val() || {}));

        const initializeAppState = () => {
            listenToData('products', renderProductsList);
            listenToData('categories', renderCategoriesList);
            listenToData('orders', renderOrdersList);
            listenToData('discounts', renderDiscountsList);
            onValue(ref(db), (snap) => renderDashboard(snap.val() || {}));
        };

        const renderDashboard = (data) => {
            const products = Object.keys(data.products || {}).length;
            const categories = Object.keys(data.categories || {}).length;
            const orders = Object.values(data.orders || {});
            const revenue = orders.filter(o => o.status !== 'Cancelled').reduce((acc, o) => acc + (o.total || 0), 0);
            document.getElementById('total-products').textContent = products;
            document.getElementById('total-categories').textContent = categories;
            document.getElementById('total-orders').textContent = orders.length;
            document.getElementById('total-revenue').textContent = formatCurrency(revenue);
            const pendingOrders = orders.filter(o => o.status === 'Pending');
            document.getElementById('pending-orders-list').innerHTML = pendingOrders.map(o => `
                <div class="sub-cat-item">
                    <span>${o.shippingDetails?.name} - ${formatCurrency(o.total)}</span>
                    <span style="color:#d97706; font-size:0.8rem; font-weight:700;">Pending</span>
                </div>
            `).join('') || '<div style="padding:1rem; text-align:center; color:#888;">No pending orders</div>';
        };

        const renderProductsList = (products) => {
            currentProducts = products;
            document.getElementById('products-list').innerHTML = Object.entries(products).map(([id, p]) => `
                <div class="product-card">
                    <img src="${(p.imageUrls && p.imageUrls[0]) || p.imageUrl || ''}" class="product-img">
                    <div class="product-details">
                        <h4>${p.name}</h4>
                        <div class="product-category">${p.categoryName}${p.subCategory ? ' > '+p.subCategory : ''}</div>
                        <div class="product-price">${p.hasVariants ? 'Variants' : formatCurrency(p.price)}</div>
                    </div>
                    <div class="actions-group">
                        <button class="btn-edit" data-id="${id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('') || '<p style="text-align:center;">No products found.</p>';
        };

        const renderCategoriesList = (cats) => {
            currentCategories = cats;
            document.getElementById('categories-list').innerHTML = Object.entries(cats).map(([id, c]) => `
                <div class="category-item">
                    <img src="${c.imageUrl}" class="category-img">
                    <span class="category-name">${c.name}</span>
                    <div class="actions-group">
                        <button class="btn-edit" data-id="${id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
            
            // Populate dropdowns for Product Modal & Sub Cat Page
            const options = '<option value="">Select Category</option>' + Object.entries(cats).map(([id, c]) => `<option value="${id}">${c.name}</option>`).join('');
            document.getElementById('product-category').innerHTML = options;
            document.getElementById('manage-sub-cat-parent').innerHTML = options;
        };

        // --- SUB CATEGORY MANAGEMENT LOGIC ---
        const parentCatSelect = document.getElementById('manage-sub-cat-parent');
        const subCatSettingsArea = document.getElementById('sub-cat-settings-area');
        const enableToggle = document.getElementById('enable-sub-cats-toggle');
        const creationArea = document.getElementById('sub-cat-creation-area');
        const subCatList = document.getElementById('current-sub-cat-list');
        const newSubCatInput = document.getElementById('new-sub-cat-input');
        const addSubCatBtn = document.getElementById('add-new-sub-cat-btn');

        parentCatSelect.addEventListener('change', async (e) => {
            const catId = e.target.value;
            if(!catId) {
                subCatSettingsArea.classList.add('d-none');
                return;
            }
            subCatSettingsArea.classList.remove('d-none');
            
            // Fetch Settings
            const settingsSnap = await get(ref(db, `categorySettings/${catId}`));
            const isEnabled = settingsSnap.exists() && settingsSnap.val().subCategoriesEnabled;
            enableToggle.checked = isEnabled;
            creationArea.classList.toggle('d-none', !isEnabled);
            
            if(isEnabled) loadSubCategories(catId);
        });

        enableToggle.addEventListener('change', async (e) => {
            const catId = parentCatSelect.value;
            const isEnabled = e.target.checked;
            await update(ref(db, `categorySettings/${catId}`), { subCategoriesEnabled: isEnabled });
            creationArea.classList.toggle('d-none', !isEnabled);
            if(isEnabled) loadSubCategories(catId);
            showToast(isEnabled ? "Sub-categories enabled" : "Sub-categories disabled");
        });

        async function loadSubCategories(catId) {
            const snap = await get(ref(db, `subCategories/${catId}`));
            subCatList.innerHTML = '';
            if(snap.exists()) {
                Object.entries(snap.val()).forEach(([subId, data]) => {
                    const el = document.createElement('div');
                    el.className = 'sub-cat-item';
                    el.innerHTML = `<span>${data.name}</span> <button class="sub-cat-delete" onclick="deleteSubCat('${catId}', '${subId}')"><i class="fas fa-trash"></i></button>`;
                    subCatList.appendChild(el);
                });
            } else {
                subCatList.innerHTML = '<p style="font-size:0.9rem; color:#888;">No sub-categories added yet.</p>';
            }
        }

        addSubCatBtn.addEventListener('click', async () => {
            const catId = parentCatSelect.value;
            const name = newSubCatInput.value.trim();
            if(!name) return showToast('Enter name', 'error');
            
            await push(ref(db, `subCategories/${catId}`), { name: name });
            newSubCatInput.value = '';
            loadSubCategories(catId);
            showToast('Added');
        });

        window.deleteSubCat = async (catId, subId) => {
            if(confirm('Delete this sub-category?')) {
                await remove(ref(db, `subCategories/${catId}/${subId}`));
                loadSubCategories(catId);
            }
        };

        // --- PRODUCT MODAL LOGIC ---
        const prodCatSelect = document.getElementById('product-category');
        const prodSubCatGroup = document.getElementById('product-sub-cat-group');
        const prodSubCatSelect = document.getElementById('product-sub-category-select');
        const prodFoodTypeContainer = document.getElementById('food-type-container');

        prodCatSelect.addEventListener('change', async (e) => {
            const catId = e.target.value;
            const catName = e.target.options[e.target.selectedIndex]?.text.toLowerCase() || '';

            // 1. Food Type Tag Logic
            if(catName.includes('fast') || catName.includes('grocery') || catName.includes('food') || catName.includes('non') || catName.includes('veg')) {
                prodFoodTypeContainer.classList.remove('d-none');
            } else {
                prodFoodTypeContainer.classList.add('d-none');
                document.getElementById('product-food-type').value = 'none';
            }

            // 2. Sub Category Logic
            prodSubCatGroup.classList.add('d-none');
            prodSubCatSelect.innerHTML = '<option value="">Select Sub Category</option>';
            prodSubCatSelect.required = false;

            if(catId) {
                const settingsSnap = await get(ref(db, `categorySettings/${catId}`));
                if(settingsSnap.exists() && settingsSnap.val().subCategoriesEnabled) {
                    const subSnap = await get(ref(db, `subCategories/${catId}`));
                    if(subSnap.exists()) {
                        prodSubCatGroup.classList.remove('d-none');
                        prodSubCatSelect.required = true;
                        Object.entries(subSnap.val()).forEach(([sid, data]) => {
                            prodSubCatSelect.innerHTML += `<option value="${data.name}">${data.name}</option>`;
                        });
                    }
                }
            }
        });

        // --- AI FUNCTIONS ---
        async function callAI(prompt, model, imageUrls = []) {
            const content = [{ type: "text", text: prompt }];
            if (imageUrls && imageUrls.length > 0) {
                imageUrls.slice(0, 4).forEach(url => {
                    content.push({ type: "image_url", image_url: { url: url } });
                });
            }
            const messages = [{ role: "user", content: content }];
            const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${OPENROUTER_API_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({ model: model, messages: messages })
            });
            if (!response.ok) throw new Error("AI Error");
            const json = await response.json();
            return json.choices[0].message.content;
        }

        // --- FIXED AI TEXT GENERATION (SHORT NAME, LONG DESC) ---
        document.getElementById('ai-generate-text-btn').addEventListener('click', async function() {
            const name = document.getElementById('product-name').value;
            if (!name) return showToast('Enter name first', 'error');
            this.classList.add('ai-loading');
            try {
                // Modified Prompt: Short Name (max 10 words) and Very Long Description
                const prompt = `You are an expert e-commerce copywriter.
                1. Product Name: Rewrite "${name}" to be **concise, professional, and SEO-friendly** (Max 6-10 words). strictly NO long titles.
                2. Description: Write an **extremely detailed, long-form, and persuasive** product description. Include formatted sections using HTML tags (<p>, <ul>, <li>, <strong>) for Features, Benefits, Usage, and Specifications.
                Output ONLY valid JSON format: {"name": "...", "description": "..."}`;
                
                const res = await callAI(prompt, TEXT_MODEL);
                const jsonBlock = res.match(/\{[\s\S]*\}/);
                if(jsonBlock) {
                    const json = JSON.parse(jsonBlock[0]);
                    document.getElementById('product-name').value = json.name;
                    document.getElementById('product-description').value = json.description;
                    showToast('AI Rewrite Done!');
                } else { throw new Error('Invalid JSON'); }
            } catch (e) { console.error(e); showToast('AI Failed', 'error'); }
            this.classList.remove('ai-loading');
        });

        // --- FIXED AI IMAGE ANALYSIS (SHORT NAME, LONG DESC) ---
        document.getElementById('ai-analyze-image-btn').addEventListener('click', async function() {
            const urlString = document.getElementById('product-image-urls-hidden').value;
            if (!urlString) return showToast('Upload images first', 'error');
            
            const urls = urlString.split(',').filter(x => x);
            const btn = this;
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            btn.disabled = true;
            
            try {
                // Modified Prompt for Vision Model
                const prompt = `Analyze these product images. 
                1. Provide a **short, catchy, and professional** Product Name (Max 1 line, under 10 words).
                2. Write a **very long, comprehensive, and detailed** description suitable for a top-tier e-commerce site. Use HTML tags (<p>, <ul>, <li>, <strong>) to structure the content with Features, Benefits, and Specifications.
                Output ONLY valid JSON: {"name": "...", "description": "..."}`;
                
                const res = await callAI(prompt, IMAGE_MODEL, urls);
                const jsonBlock = res.match(/\{[\s\S]*\}/);
                if(jsonBlock) {
                    const json = JSON.parse(jsonBlock[0]);
                    document.getElementById('product-name').value = json.name;
                    document.getElementById('product-description').value = json.description;
                    showToast('Analyzed!');
                } else { throw new Error('Invalid JSON'); }
            } catch (e) { 
                console.error(e);
                showToast('Analysis Failed', 'error'); 
            }
            btn.innerHTML = oldText;
            btn.disabled = false;
        });

        // --- UPLOAD LOGIC ---
        async function uploadToImgBB(file) {
            const fd = new FormData(); fd.append('image', file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:'POST', body:fd });
            return (await res.json()).data.url;
        }

        function addPreview(container, fileUrl, isFileObject = false, onDeleteCallback) {
            const item = document.createElement('div');
            item.className = 'preview-item';
            
            const img = document.createElement('img');
            if (isFileObject) {
                const reader = new FileReader();
                reader.onload = e => img.src = e.target.result;
                reader.readAsDataURL(fileUrl);
            } else {
                img.src = fileUrl;
            }
            item.appendChild(img);

            const del = document.createElement('button');
            del.className = 'delete-preview';
            del.innerHTML = '<i class="fas fa-times"></i>';
            del.type = 'button'; 
            
            del.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
                item.remove();
                if(onDeleteCallback) onDeleteCallback();
            });
            
            item.appendChild(del);
            container.appendChild(item);
            return item;
        }

        function updateProductUrls() {
            const urls = [];
            document.querySelectorAll('#product-image-previews img').forEach(img => {
                if (img.src.startsWith('http')) urls.push(img.src);
            });
            document.getElementById('product-image-urls-hidden').value = urls.join(',');
        }

        document.getElementById('upload-product-images-btn').addEventListener('click', async () => {
            const files = document.getElementById('product-image-upload').files;
            if(!files.length) return;
            
            const container = document.getElementById('product-image-previews');
            const uploadBtn = document.getElementById('upload-product-images-btn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            for(let f of files) {
                try {
                    const url = await uploadToImgBB(f);
                    addPreview(container, url, false, updateProductUrls);
                } catch(e) { showToast('Upload failed', 'error'); }
            }
            
            updateProductUrls();
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'Upload';
            document.getElementById('product-image-upload').value = '';
            showToast('Images Uploaded');
        });

        document.getElementById('upload-category-image-btn').addEventListener('click', async () => {
            const file = document.getElementById('category-image-upload').files[0];
            if(!file) return;
            const url = await uploadToImgBB(file);
            document.getElementById('category-image-preview').innerHTML = '';
            addPreview(document.getElementById('category-image-preview'), url, false, () => {
                document.getElementById('category-image-hidden').value = '';
            });
            document.getElementById('category-image-hidden').value = url;
            showToast('Image Uploaded');
        });

        // --- SUBMISSION HANDLERS (FIXED VARIANT SAVING) ---
        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            updateProductUrls();
            
            const id = document.getElementById('product-id').value;
            const hasVariants = document.getElementById('has-variants-checkbox').checked;
            const rawUrls = document.getElementById('product-image-urls-hidden').value;
            
            if(!rawUrls) return showToast('Please upload an image', 'error');

            const data = {
                name: document.getElementById('product-name').value,
                categoryId: document.getElementById('product-category').value,
                categoryName: document.getElementById('product-category').selectedOptions[0].text,
                subCategory: document.getElementById('product-sub-category-select').value || null,
                foodType: document.getElementById('product-food-type').value,
                description: document.getElementById('product-description').value,
                imageUrls: rawUrls.split(','),
                hasVariants: hasVariants,
                status: 'approved'
            };
            
            if(data.imageUrls.length) data.imageUrl = data.imageUrls[0]; 

            // --- FIXED VARIANT LOGIC HERE ---
            if(hasVariants) {
                const vars = [];
                const variantDivs = document.querySelectorAll('.variant-entry');
                
                variantDivs.forEach(div => {
                    const vName = div.querySelector('.variant-name').value;
                    const vPrice = parseFloat(div.querySelector('.variant-price').value);
                    const vOrgPriceStr = div.querySelector('.variant-original-price').value;
                    const vStock = parseInt(div.querySelector('.variant-stock').value);

                    // Validate that Name and Price exist (handle NaN issues)
                    if(vName && !isNaN(vPrice)) {
                        vars.push({
                            name: vName,
                            price: vPrice,
                            originalPrice: vOrgPriceStr ? parseFloat(vOrgPriceStr) : null, // Handle empty string correctly
                            stock: isNaN(vStock) ? 0 : vStock
                        });
                    }
                });

                if(vars.length === 0) return showToast('Add at least 1 valid variant', 'error');
                data.variants = vars;
                data.price = vars[0].price; // Display price is first variant
            } else {
                data.price = parseFloat(document.getElementById('product-price').value);
                data.originalPrice = parseFloat(document.getElementById('product-original-price').value) || null;
                data.stock = parseInt(document.getElementById('product-stock').value);
            }

            if(id) await update(ref(db, `products/${id}`), data);
            else await push(ref(db, 'products'), data);
            
            showToast(id ? 'Updated' : 'Created');
            document.getElementById('product-modal').classList.remove('open');
        });

        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('category-id').value;
            const data = {
                name: document.getElementById('category-name').value,
                imageUrl: document.getElementById('category-image-hidden').value
            };
            if(id) await update(ref(db, `categories/${id}`), data);
            else await push(ref(db, 'categories'), data);
            showToast(id ? 'Updated' : 'Created');
            document.getElementById('category-modal').classList.remove('open');
        });

        // --- HELPER FUNCTIONS ---
        const modals = document.querySelectorAll('.modal');
        const closeModal = (id) => document.getElementById(id).classList.remove('open');
        document.querySelectorAll('.close-modal-btn').forEach(b => b.onclick = (e) => closeModal(e.target.dataset.target.substring(1)));
        
        // Open Modal logic
        document.getElementById('add-product-btn').onclick = () => {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-image-previews').innerHTML = '';
            document.getElementById('product-image-urls-hidden').value = '';
            document.getElementById('variants-list').innerHTML = '';
            document.getElementById('modal-product-title').textContent = 'Add Product';
            
            // Reset check
            document.getElementById('has-variants-checkbox').checked = false;
            document.getElementById('simple-product-fields').classList.remove('d-none');
            document.getElementById('variant-product-fields').classList.add('d-none');

            document.getElementById('product-modal').classList.add('open');
        };

        document.getElementById('add-category-btn').onclick = () => {
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            document.getElementById('category-image-preview').innerHTML = '';
            document.getElementById('category-image-hidden').value = '';
            document.getElementById('category-modal').classList.add('open');
        };

        // Variant UI Logic
        const hasVariantsCheck = document.getElementById('has-variants-checkbox');
        hasVariantsCheck.addEventListener('change', () => {
            document.getElementById('simple-product-fields').classList.toggle('d-none', hasVariantsCheck.checked);
            document.getElementById('variant-product-fields').classList.toggle('d-none', !hasVariantsCheck.checked);
        });

        document.getElementById('add-variant-btn').onclick = () => {
            const div = document.createElement('div');
            div.className = 'variant-entry';
            div.innerHTML = `
                <input type="text" class="variant-name" placeholder="Name (e.g. 1kg)" required>
                <input type="number" class="variant-price" placeholder="Selling â‚¹" required>
                <input type="number" class="variant-original-price" placeholder="Original â‚¹">
                <input type="number" class="variant-stock" placeholder="Stock" required>
                <button type="button" class="remove-variant-btn">Remove</button>
            `;
            div.querySelector('.remove-variant-btn').onclick = () => div.remove();
            document.getElementById('variants-list').appendChild(div);
        };

        // Edit Product logic
        document.getElementById('products-list').addEventListener('click', async (e) => {
            const btn = e.target.closest('.btn-edit');
            if(btn) {
                const id = btn.dataset.id;
                const p = currentProducts[id];
                
                document.getElementById('product-id').value = id;
                document.getElementById('product-name').value = p.name;
                document.getElementById('product-description').value = p.description;
                document.getElementById('product-category').value = p.categoryId;
                
                const event = new Event('change');
                document.getElementById('product-category').dispatchEvent(event);
                
                setTimeout(() => {
                    if(p.subCategory) document.getElementById('product-sub-category-select').value = p.subCategory;
                }, 500);

                if(p.foodType) document.getElementById('product-food-type').value = p.foodType;
                
                // Handle Variants
                hasVariantsCheck.checked = p.hasVariants || false;
                
                // Force toggle UI
                document.getElementById('simple-product-fields').classList.toggle('d-none', hasVariantsCheck.checked);
                document.getElementById('variant-product-fields').classList.toggle('d-none', !hasVariantsCheck.checked);
                
                if(!p.hasVariants) {
                    document.getElementById('product-price').value = p.price;
                    document.getElementById('product-original-price').value = p.originalPrice;
                    document.getElementById('product-stock').value = p.stock;
                } else {
                    document.getElementById('variants-list').innerHTML = '';
                    if(p.variants) {
                        p.variants.forEach(v => {
                            const div = document.createElement('div');
                            div.className = 'variant-entry';
                            div.innerHTML = `
                                <input type="text" class="variant-name" value="${v.name}" required>
                                <input type="number" class="variant-price" value="${v.price}" required>
                                <input type="number" class="variant-original-price" value="${v.originalPrice || ''}">
                                <input type="number" class="variant-stock" value="${v.stock}" required>
                                <button type="button" class="remove-variant-btn">Remove</button>
                            `;
                            div.querySelector('.remove-variant-btn').onclick = () => div.remove();
                            document.getElementById('variants-list').appendChild(div);
                        });
                    }
                }

                // Images
                const container = document.getElementById('product-image-previews');
                container.innerHTML = '';
                const urls = p.imageUrls || (p.imageUrl ? [p.imageUrl] : []);
                document.getElementById('product-image-urls-hidden').value = urls.join(',');
                
                urls.forEach(url => {
                    addPreview(container, url, false, updateProductUrls);
                });

                document.getElementById('modal-product-title').textContent = 'Edit Product';
                document.getElementById('product-modal').classList.add('open');
            }
            
            const delBtn = e.target.closest('.btn-delete');
            if(delBtn && confirm('Delete?')) {
                await remove(ref(db, `products/${delBtn.dataset.id}`));
                showToast('Deleted');
            }
        });

        // Other listeners
        const renderOrdersList = (orders) => {
            document.getElementById('orders-list').innerHTML = Object.entries(orders).sort((a,b)=>new Date(b[1].date)-new Date(a[1].date)).map(([id, o]) => `
                <div class="order-row">
                    <div class="order-main"><h4>${o.shippingDetails?.name}</h4><small>${formatDateTime(o.date)}</small></div>
                    <span class="order-status ${o.status}">${o.status}</span>
                    <div class="order-amount">${formatCurrency(o.total)}</div>
                </div>
            `).join('');
        };
        
        const renderDiscountsList = (discounts) => {
            document.getElementById('discounts-list').innerHTML = Object.entries(discounts).map(([id, d]) => `
                <div class="discount-item"><span class="discount-code">${d.code}</span><span class="discount-value">${d.value}${d.type==='percent'?'%':''}</span></div>
            `).join('');
        };

        document.getElementById('add-discount-btn').onclick = () => document.getElementById('discount-modal').classList.add('open');
        document.getElementById('discount-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                code: document.getElementById('discount-code').value.toUpperCase(),
                type: document.getElementById('discount-type').value,
                value: parseFloat(document.getElementById('discount-value').value),
                max: parseFloat(document.getElementById('discount-max').value) || 0
            };
            await push(ref(db, 'discounts'), data);
            showToast('Discount Added');
            document.getElementById('discount-modal').classList.remove('open');
        }
    </script>
</body>
</html>