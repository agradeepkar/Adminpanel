<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>DuckShop Â· Admin (Mobile)</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f7fb;
            color: #1e293b;
            font-size: 15px;
            line-height: 1.5;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(145deg, #3b82f6 0%, #8b5cf6 100%);
            padding: 1rem;
        }
        .login-box {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 380px;
            padding: 2rem 1.5rem;
            border-radius: 28px;
            box-shadow: 0 20px 35px rgba(0,0,0,0.2);
        }
        .login-box h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            text-align: center;
            color: #1e293b;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #334155;
        }
        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 18px;
            font-size: 1rem;
            background: white;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 1rem 2rem;
            border: none;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            background: #e2e8f0;
            color: #1e293b;
            width: 100%;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:active {
            background: #2563eb;
        }

        /* Admin wrapper */
        .admin-wrapper {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f8fafc;
            position: relative;
        }

        /* Top header */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.2rem;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            z-index: 20;
        }
        .menu-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #3b82f6;
            cursor: pointer;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .app-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0f172a;
        }
        .header-placeholder {
            width: 48px;
        }

        /* Drawer (sidebar) */
        .drawer {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 280px;
            background: white;
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            transform: translateX(-100%);
            transition: transform 0.25s ease;
            z-index: 100;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
        }
        .drawer.open {
            transform: translateX(0);
        }
        .drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2.5rem;
            padding: 0 0.5rem;
        }
        .drawer-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(145deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .close-drawer {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #64748b;
        }
        .drawer-nav {
            list-style: none;
            flex: 1;
        }
        .drawer-nav li {
            margin-bottom: 0.75rem;
        }
        .drawer-nav a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.2rem;
            color: #334155;
            font-weight: 500;
            border-radius: 16px;
            text-decoration: none;
            font-size: 1.1rem;
            transition: background 0.2s;
        }
        .drawer-nav a i {
            width: 28px;
            font-size: 1.3rem;
            color: #3b82f6;
        }
        .drawer-nav a.active {
            background: #3b82f6;
            color: white;
        }
        .drawer-nav a.active i {
            color: white;
        }
        #logout-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.2rem;
            background: none;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            color: #ef4444;
            font-weight: 500;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
        }

        /* Overlay when drawer open */
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            visibility: hidden;
            transition: 0.2s;
            z-index: 90;
        }
        .drawer-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        /* Main content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.2rem;
            -webkit-overflow-scrolling: touch;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        /* Dashboard stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            border-radius: 24px;
            padding: 1.2rem 1rem;
            box-shadow: 0 6px 14px rgba(0,0,0,0.03);
            border: 1px solid #e9eef2;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }
        .stat-icon {
            width: 52px;
            height: 52px;
            border-radius: 18px;
            background: #dbeafe;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #3b82f6;
        }
        .stat-info h3 {
            font-size: 1.6rem;
            font-weight: 700;
            line-height: 1.2;
            color: #0f172a;
        }
        .stat-info p {
            font-size: 0.8rem;
            color: #64748b;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        /* Pending orders list */
        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 1.5rem 0 1rem;
            color: #0f172a;
        }
        .order-list {
            background: white;
            border-radius: 24px;
            padding: 0.5rem 0;
            border: 1px solid #e2e8f0;
        }
        .order-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.2rem;
            border-bottom: 1px solid #f1f5f9;
        }
        .order-item:last-child {
            border-bottom: none;
        }
        .order-info p {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .order-info small {
            color: #64748b;
            font-size: 0.8rem;
        }
        .order-status {
            background: #fef3c7;
            color: #b45309;
            padding: 0.3rem 1rem;
            border-radius: 30px;
            font-size: 0.75rem;
            font-weight: 700;
        }
        .order-status.shipped { background: #dbeafe; color: #1e40af; }
        .order-status.delivered { background: #d1fae5; color: #065f46; }
        .order-status.cancelled { background: #fee2e2; color: #991b1b; }

        /* Content header with add button */
        .content-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        .content-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #0f172a;
        }
        .btn-add {
            background: #3b82f6;
            color: white;
            border: none;
            width: 52px;
            height: 52px;
            border-radius: 30px;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 12px rgba(59,130,246,0.3);
            cursor: pointer;
        }

        /* Product card list (instead of table) */
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .product-card {
            background: white;
            border-radius: 22px;
            padding: 1rem;
            border: 1px solid #edf2f7;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .product-img {
            width: 70px;
            height: 70px;
            border-radius: 18px;
            object-fit: cover;
            background: #f1f5f9;
        }
        .product-details {
            flex: 1;
        }
        .product-details h4 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.2rem;
        }
        .product-details .product-category {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.3rem;
        }
        .product-details .product-price {
            font-weight: 700;
            color: #3b82f6;
        }
        .product-actions {
            display: flex;
            gap: 0.5rem;
        }
        .product-actions button {
            width: 44px;
            height: 44px;
            border-radius: 18px;
            border: 1px solid #e2e8f0;
            background: white;
            font-size: 1.2rem;
            color: #334155;
            cursor: pointer;
        }
        .product-actions .btn-delete { color: #ef4444; }

        /* Category list */
        .category-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .category-item {
            background: white;
            border-radius: 20px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid #edf2f7;
        }
        .category-img {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            object-fit: cover;
        }
        .category-name {
            flex: 1;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .category-actions button {
            width: 44px;
            height: 44px;
            border-radius: 18px;
            border: 1px solid #e2e8f0;
            background: white;
            margin-left: 0.5rem;
        }

        /* Orders table - card style */
        .orders-list {
            background: white;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
        }
        .order-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.2rem;
            border-bottom: 1px solid #f1f5f9;
        }
        .order-row:last-child {
            border-bottom: none;
        }
        .order-main h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        .order-main small {
            color: #64748b;
            font-size: 0.8rem;
        }
        .order-amount {
            font-weight: 700;
            color: #0f172a;
        }

        /* Discount list */
        .discount-list {
            background: white;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
        }
        .discount-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.2rem;
            border-bottom: 1px solid #f1f5f9;
        }
        .discount-code {
            font-weight: 700;
            font-size: 1.1rem;
            background: #f1f5f9;
            padding: 0.2rem 1rem;
            border-radius: 30px;
        }
        .discount-value {
            font-weight: 600;
        }

        /* Modal (full screen on mobile) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: 0.2s;
            z-index: 200;
        }
        .modal.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            padding: 2rem 1.5rem;
            transform: translateY(100%);
            transition: transform 0.25s;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
        }
        .modal.open .modal-content {
            transform: translateY(0);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .modal-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
        }
        .close-modal-btn {
            background: none;
            border: none;
            font-size: 2.2rem;
            cursor: pointer;
            color: #64748b;
        }
        /* Form inside modal */
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.4rem;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 20px;
            font-size: 1rem;
            background: white;
        }
        .variant-entry {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background: #f8fafc;
            padding: 1rem;
            border-radius: 20px;
            margin-bottom: 1rem;
        }
        .variant-entry input {
            margin-bottom: 0.5rem;
        }
        .remove-variant-btn {
            background: #fee2e2;
            border: none;
            padding: 0.8rem;
            border-radius: 18px;
            color: #ef4444;
            font-weight: 600;
        }
        .image-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 0.8rem;
            margin: 1rem 0;
        }
        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .delete-preview {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 20px;
            right: 20px;
            background: #1e293b;
            color: white;
            padding: 1rem;
            border-radius: 30px;
            text-align: center;
            font-weight: 500;
            opacity: 0;
            visibility: hidden;
            transition: 0.2s;
            z-index: 300;
        }
        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        .d-none { display: none !important; }
        hr { margin: 1.5rem 0; border: none; border-top: 1px solid #e2e8f0; }
    </style>
</head>
<body>
    <!-- Login View -->
    <div id="login-view">
        <div class="login-container">
            <div class="login-box">
                <h1>ðŸ¦† DuckShop</h1>
                <form id="admin-code-form">
                    <div class="form-group">
                        <label for="admin-code">4-digit code</label>
                        <input type="password" id="admin-code" required maxlength="4" pattern="\d{4}" inputmode="numeric" placeholder="â€¢â€¢â€¢â€¢">
                    </div>
                    <button type="submit" class="btn btn-primary">Enter</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Admin Mobile View -->
    <div id="admin-view" class="admin-wrapper d-none">
        <!-- Header -->
        <div class="app-header">
            <button class="menu-btn" id="menuToggle"><i class="fas fa-bars"></i></button>
            <h1 id="page-title">Dashboard</h1>
            <div class="header-placeholder"></div>
        </div>

        <!-- Drawer (sidebar) -->
        <div class="drawer" id="drawer">
            <div class="drawer-header">
                <h2>DuckShop</h2>
                <button class="close-drawer" id="closeDrawer"><i class="fas fa-times"></i></button>
            </div>
            <ul class="drawer-nav">
                <li><a href="#dashboard" class="nav-link active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#products" class="nav-link"><i class="fas fa-box"></i> Products</a></li>
                <li><a href="#categories" class="nav-link"><i class="fas fa-sitemap"></i> Categories</a></li>
                <li><a href="#orders" class="nav-link"><i class="fas fa-shopping-cart"></i> Orders</a></li>
                <li><a href="#discounts" class="nav-link"><i class="fas fa-tag"></i> Discounts</a></li>
            </ul>
            <button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
        <div class="drawer-overlay" id="drawerOverlay"></div>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dashboard Page -->
            <section id="dashboard-page" class="page active">
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-box"></i></div><div class="stat-info"><h3 id="total-products">0</h3><p>Products</p></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-sitemap"></i></div><div class="stat-info"><h3 id="total-categories">0</h3><p>Categories</p></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-shopping-cart"></i></div><div class="stat-info"><h3 id="total-orders">0</h3><p>Total orders</p></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-clock"></i></div><div class="stat-info"><h3 id="pending-orders">0</h3><p>Pending</p></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-check-circle"></i></div><div class="stat-info"><h3 id="completed-orders">0</h3><p>Completed</p></div></div>
                    <div class="stat-card"><div class="stat-icon"><i class="fas fa-rupee-sign"></i></div><div class="stat-info"><h3 id="total-revenue">â‚¹0</h3><p>Revenue</p></div></div>
                </div>
                <h3 class="section-title">Pending Orders</h3>
                <div id="pending-orders-list" class="order-list"></div>
            </section>

            <!-- Products Page -->
            <section id="products-page" class="page">
                <div class="content-header">
                    <h2>Products</h2>
                    <button class="btn-add" id="add-product-btn"><i class="fas fa-plus"></i></button>
                </div>
                <div id="products-list" class="product-list"></div>
            </section>

            <!-- Categories Page -->
            <section id="categories-page" class="page">
                <div class="content-header">
                    <h2>Categories</h2>
                    <button class="btn-add" id="add-category-btn"><i class="fas fa-plus"></i></button>
                </div>
                <div id="categories-list" class="category-list"></div>
            </section>

            <!-- Orders Page -->
            <section id="orders-page" class="page">
                <div class="content-header">
                    <h2>Orders</h2>
                </div>
                <div id="orders-list" class="orders-list"></div>
            </section>

            <!-- Discounts Page -->
            <section id="discounts-page" class="page">
                <div class="content-header">
                    <h2>Discounts</h2>
                    <button class="btn-add" id="add-discount-btn"><i class="fas fa-plus"></i></button>
                </div>
                <div id="discounts-list" class="discount-list"></div>
            </section>
        </main>

        <!-- Modals (full screen on mobile) -->
        <!-- Product Modal -->
        <div id="product-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-product-title">Add Product</h2>
                    <button class="close-modal-btn" data-target="#product-modal">&times;</button>
                </div>
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="form-group">
                        <label for="product-name">Product Name</label>
                        <input type="text" id="product-name" required>
                    </div>
                    <div class="form-group">
                        <label for="product-category">Category</label>
                        <select id="product-category" required><option value="">Select</option></select>
                    </div>
                    <input type="hidden" id="product-image-urls-hidden" value="">
                    <div class="form-group">
                        <label>Images</label>
                        <input type="file" id="product-image-upload" accept="image/*" multiple>
                        <button type="button" id="upload-product-images-btn" class="btn btn-primary" style="margin-top: 8px;">Upload</button>
                        <div id="product-image-previews" class="image-previews"></div>
                    </div>
                    <div class="form-group">
                        <label for="product-description">Description</label>
                        <textarea id="product-description" rows="3" required></textarea>
                    </div>
                    <div class="form-check" style="display: flex; align-items: center; gap: 0.5rem; margin: 1rem 0;">
                        <input type="checkbox" id="has-variants-checkbox">
                        <label for="has-variants-checkbox">Has variants (e.g., 500g, 1kg)</label>
                    </div>
                    <div id="simple-product-fields">
                        <div class="form-group">
                            <label for="product-price">Selling Price (â‚¹)</label>
                            <input type="number" id="product-price" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="product-original-price">Original Price (â‚¹)</label>
                            <input type="number" id="product-original-price" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="product-stock">Stock</label>
                            <input type="number" id="product-stock" min="0" required>
                        </div>
                    </div>
                    <div id="variant-product-fields" class="d-none">
                        <div id="variants-list"></div>
                        <button type="button" id="add-variant-btn" class="btn btn-primary">+ Add Variant</button>
                    </div>
                    <hr>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </form>
            </div>
        </div>

        <!-- Category Modal -->
        <div id="category-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-category-title">Add Category</h2>
                    <button class="close-modal-btn" data-target="#category-modal">&times;</button>
                </div>
                <form id="category-form">
                    <input type="hidden" id="category-id">
                    <div class="form-group">
                        <label for="category-name">Category Name</label>
                        <input type="text" id="category-name" required>
                    </div>
                    <input type="hidden" id="category-image-hidden" value="">
                    <div class="form-group">
                        <label>Image</label>
                        <input type="file" id="category-image-upload" accept="image/*">
                        <button type="button" id="upload-category-image-btn" class="btn btn-primary btn-sm" style="margin-top:8px;">Upload</button>
                        <div id="category-image-preview" class="image-previews"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Category</button>
                </form>
            </div>
        </div>

        <!-- Order Details Modal -->
        <div id="order-details-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Order Details</h2>
                    <button class="close-modal-btn" data-target="#order-details-modal">&times;</button>
                </div>
                <div>
                    <h3>Customer</h3>
                    <p><strong>Name:</strong> <span id="detail-customer-name"></span></p>
                    <p><strong>Phone:</strong> <span id="detail-customer-phone"></span></p>
                    <p><strong>Address:</strong> <span id="detail-customer-address"></span>, <span id="detail-customer-city"></span> - <span id="detail-customer-pincode"></span></p>
                    <h3>Order</h3>
                    <p><strong>Order ID:</strong> <span id="detail-order-id"></span></p>
                    <p><strong>Date:</strong> <span id="detail-order-date"></span></p>
                    <p><strong>Discount:</strong> <span id="detail-order-discount"></span></p>
                    <div class="status-update-form" style="display:flex; gap:0.5rem; margin:1rem 0;">
                        <select id="detail-order-status-select" style="flex:1; padding:0.8rem; border-radius:20px;">
                            <option value="Pending">Pending</option>
                            <option value="Shipped">Shipped</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <button id="update-status-btn" class="btn btn-primary">Update</button>
                    </div>
                    <h3>Products</h3>
                    <div id="order-details-products" class="product-list"></div>
                    <div style="margin-top:1rem; text-align:right;">
                        <p><strong>Subtotal:</strong> <span id="detail-order-subtotal"></span></p>
                        <p><strong>Discount:</strong> <span id="detail-order-discount-amount"></span></p>
                        <p><strong>Delivery:</strong> <span id="detail-order-delivery"></span></p>
                        <p><strong>Total:</strong> <span id="detail-order-total"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discount Modal -->
        <div id="discount-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modal-discount-title">Add Discount</h2>
                    <button class="close-modal-btn" data-target="#discount-modal">&times;</button>
                </div>
                <form id="discount-form">
                    <input type="hidden" id="discount-id">
                    <div class="form-group">
                        <label for="discount-code">Code</label>
                        <input type="text" id="discount-code" required>
                    </div>
                    <div class="form-group">
                        <label for="discount-type">Type</label>
                        <select id="discount-type" required>
                            <option value="percent">Percentage (%)</option>
                            <option value="fixed">Fixed (â‚¹)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="discount-value">Value</label>
                        <input type="number" id="discount-value" min="0" step="0.01" required>
                    </div>
                    <div class="form-group d-none" id="max-discount-group">
                        <label for="discount-max">Max Discount (â‚¹)</label>
                        <input type="number" id="discount-max" min="0" step="0.01">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Discount</button>
                </form>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, onValue, set, push, remove, get } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB7P6KPjrJXI2GBHvgRIj7-djZEb2itImQ",
          authDomain: "duckshop-2026.firebaseapp.com",
          databaseURL: "https://duckshop-2026-default-rtdb.firebaseio.com",
          projectId: "duckshop-2026",
          storageBucket: "duckshop-2026.firebasestorage.app",
          messagingSenderId: "707987638458",
          appId: "1:707987638458:web:014ceda971a863fbab9a83"
        };  
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // UI Elements
        const loginView = document.getElementById('login-view');
        const adminView = document.getElementById('admin-view');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const drawer = document.getElementById('drawer');
        const menuToggle = document.getElementById('menuToggle');
        const closeDrawer = document.getElementById('closeDrawer');
        const drawerOverlay = document.getElementById('drawerOverlay');
        const pageTitle = document.getElementById('page-title');

        let currentProducts = {}, currentOrders = {}, currentDiscounts = {}, currentCategories = {};
        const IMGBB_API_KEY = '3d6e523beca3399d739ded007d03a61a';

        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        const formatCurrency = (amount) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(amount || 0);
        const formatDateTime = (ts) => ts ? new Date(ts).toLocaleString('en-IN', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }) : 'N/A';
        const generateNumericOrderId = (key) => {
            let hash = 0;
            for (let i = 0; i < key.length; i++) hash = ((hash<<5)-hash) + key.charCodeAt(i);
            return ('90'+Math.abs(hash)).slice(0,12);
        };

        // Login
        document.getElementById('admin-code-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('admin-code').value;
            try {
                const snap = await get(ref(db, 'adminUsers'));
                if (snap.exists() && Object.values(snap.val()).some(u => u.code === code)) {
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    showToast('Welcome');
                    loginView.classList.add('d-none');
                    adminView.classList.remove('d-none');
                    initializeAppState();
                    handleRouting();
                } else showToast('Invalid code', 'error');
            } catch (err) { showToast('Login failed', 'error'); }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('isAdminLoggedIn');
            window.location.reload();
        });

        const checkLogin = () => {
            if (sessionStorage.getItem('isAdminLoggedIn') === 'true') {
                loginView.classList.add('d-none');
                adminView.classList.remove('d-none');
                initializeAppState();
                handleRouting();
            }
        };
        window.addEventListener('load', checkLogin);

        // Navigation & Drawer
        const handleRouting = () => {
            const hash = window.location.hash || '#dashboard';
            pages.forEach(p => p.classList.toggle('active', `#${p.id.replace('-page','')}` === hash));
            navLinks.forEach(l => l.classList.toggle('active', l.getAttribute('href') === hash));
            const activeLink = [...navLinks].find(l => l.getAttribute('href') === hash);
            if (activeLink) pageTitle.textContent = activeLink.textContent.trim();
            drawer.classList.remove('open');
            drawerOverlay.classList.remove('show');
        };

        window.addEventListener('hashchange', handleRouting);

        menuToggle.addEventListener('click', () => {
            drawer.classList.add('open');
            drawerOverlay.classList.add('show');
        });
        closeDrawer.addEventListener('click', () => {
            drawer.classList.remove('open');
            drawerOverlay.classList.remove('show');
        });
        drawerOverlay.addEventListener('click', () => {
            drawer.classList.remove('open');
            drawerOverlay.classList.remove('show');
        });

        // Firebase Listeners
        const listenToData = (path, cb) => onValue(ref(db, path), (s) => cb(s.val() || {}));

        const renderDashboard = (data) => {
            const products = Object.keys(data.products || {}).length;
            const categories = Object.keys(data.categories || {}).length;
            const orders = Object.values(data.orders || {});
            const totalOrders = orders.length;
            const pending = orders.filter(o => o.status === 'Pending').length;
            const completed = orders.filter(o => o.status === 'Delivered').length;
            const revenue = orders.filter(o => o.status !== 'Cancelled').reduce((acc, o) => acc + (o.total || 0), 0);
            document.getElementById('total-products').textContent = products;
            document.getElementById('total-categories').textContent = categories;
            document.getElementById('total-orders').textContent = totalOrders;
            document.getElementById('pending-orders').textContent = pending;
            document.getElementById('completed-orders').textContent = completed;
            document.getElementById('total-revenue').textContent = formatCurrency(revenue);

            const pendingOrders = orders.filter(o => o.status === 'Pending').sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('pending-orders-list').innerHTML = pendingOrders.map(o => {
                const id = Object.keys(data.orders).find(key => data.orders[key] === o);
                return `<div class="order-item">
                    <div class="order-info"><p>${o.shippingDetails?.name || 'N/A'}</p><small>${formatDateTime(o.date)}</small></div>
                    <span class="order-status">${o.status}</span>
                </div>`;
            }).join('') || '<div style="padding:1rem; text-align:center;">No pending orders</div>';
        };

        const renderProductsList = (products) => {
            currentProducts = products;
            const container = document.getElementById('products-list');
            container.innerHTML = Object.entries(products).map(([id, p]) => {
                const img = (p.imageUrls && p.imageUrls[0]) || p.imageUrl || '';
                return `<div class="product-card">
                    <img src="${img}" class="product-img" onerror="this.src='https://via.placeholder.com/70'">
                    <div class="product-details">
                        <h4>${p.name}</h4>
                        <div class="product-category">${p.categoryName || 'Uncategorized'}</div>
                        <div class="product-price">${p.hasVariants ? 'Variants' : formatCurrency(p.price)}</div>
                    </div>
                    <div class="product-actions">
                        <button class="btn-edit" data-id="${id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('') || '<div style="text-align:center; padding:2rem;">No products</div>';
        };

        const renderCategoriesList = (cats) => {
            currentCategories = cats;
            const container = document.getElementById('categories-list');
            container.innerHTML = Object.entries(cats).map(([id, c]) => `
                <div class="category-item">
                    <img src="${c.imageUrl}" class="category-img" onerror="this.src='https://via.placeholder.com/60'">
                    <span class="category-name">${c.name}</span>
                    <div class="category-actions">
                        <button class="btn-edit" data-id="${id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('') || '<div style="padding:2rem; text-align:center;">No categories</div>';
            populateCategorySelect();
        };

        const renderOrdersList = (orders) => {
            currentOrders = orders;
            const container = document.getElementById('orders-list');
            container.innerHTML = Object.entries(orders).sort((a,b) => new Date(b[1].date)-new Date(a[1].date)).map(([id, o]) => `
                <div class="order-row" data-id="${id}">
                    <div class="order-main">
                        <h4>${o.shippingDetails?.name || 'N/A'}</h4>
                        <small>${formatDateTime(o.date)}</small>
                    </div>
                    <span class="order-status ${o.status}">${o.status}</span>
                    <div class="order-amount">${formatCurrency(o.total)}</div>
                    <button class="btn-view" data-id="${id}" style="background:none; border:none; font-size:1.4rem;"><i class="fas fa-eye"></i></button>
                </div>
            `).join('') || '<div style="padding:2rem; text-align:center;">No orders</div>';
        };

        const renderDiscountsList = (discounts) => {
            currentDiscounts = discounts;
            const container = document.getElementById('discounts-list');
            container.innerHTML = Object.entries(discounts).map(([id, d]) => `
                <div class="discount-item">
                    <span class="discount-code">${d.code}</span>
                    <span class="discount-value">${d.type === 'percent' ? d.value+'%' : formatCurrency(d.value)}</span>
                    <div>
                        <button class="btn-edit" data-id="${id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete" data-id="${id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('') || '<div style="padding:2rem; text-align:center;">No discounts</div>';
        };

        const populateCategorySelect = () => {
            const sel = document.getElementById('product-category');
            sel.innerHTML = '<option value="">Select</option>';
            for (const [id, cat] of Object.entries(currentCategories)) {
                sel.innerHTML += `<option value="${id}">${cat.name}</option>`;
            }
        };

        const initializeAppState = () => {
            listenToData('products', renderProductsList);
            listenToData('categories', renderCategoriesList);
            listenToData('orders', renderOrdersList);
            listenToData('discounts', renderDiscountsList);
            onValue(ref(db), (snap) => renderDashboard(snap.val() || {}));
        };

        // Modal functions (unchanged but ensure close)
        const modals = document.querySelectorAll('.modal');
        const openModal = (id) => document.getElementById(id).classList.add('open');
        const closeModal = (id) => {
            document.getElementById(id).classList.remove('open');
            if (id === 'product-modal') {
                document.getElementById('product-image-previews').innerHTML = '';
                document.getElementById('product-image-upload').value = '';
                document.getElementById('product-image-urls-hidden').value = '';
            } else if (id === 'category-modal') {
                document.getElementById('category-image-preview').innerHTML = '';
                document.getElementById('category-image-upload').value = '';
                document.getElementById('category-image-hidden').value = '';
            }
        };
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.dataset.target.substring(1))));
        modals.forEach(m => m.addEventListener('click', e => { if (e.target === m) closeModal(m.id); }));

        // Product variant toggle
        const hasVariants = document.getElementById('has-variants-checkbox');
        const simple = document.getElementById('simple-product-fields');
        const variant = document.getElementById('variant-product-fields');
        const variantsList = document.getElementById('variants-list');
        const addVariantBtn = document.getElementById('add-variant-btn');
        hasVariants.addEventListener('change', () => {
            simple.classList.toggle('d-none', hasVariants.checked);
            variant.classList.toggle('d-none', !hasVariants.checked);
        });
        const createVariantEntry = (v = {}) => {
            const e = document.createElement('div');
            e.className = 'variant-entry';
            e.innerHTML = `
                <input type="text" class="variant-name" placeholder="Name (e.g., 500g)" value="${v.name||''}" required>
                <input type="number" class="variant-price" placeholder="Selling â‚¹" value="${v.price||''}" required>
                <input type="number" class="variant-original-price" placeholder="Original â‚¹" value="${v.originalPrice||''}">
                <input type="number" class="variant-stock" placeholder="Stock" value="${v.stock||''}" required>
                <button type="button" class="remove-variant-btn"><i class="fas fa-trash"></i> Remove</button>
            `;
            e.querySelector('.remove-variant-btn').addEventListener('click', () => e.remove());
            variantsList.appendChild(e);
        };
        addVariantBtn.addEventListener('click', () => createVariantEntry());

        // ImgBB upload (simplified)
        async function uploadToImgBB(file) {
            const fd = new FormData(); fd.append('image', file);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:'POST', body:fd });
            if (!res.ok) throw new Error('Upload failed');
            return (await res.json()).data.url;
        }

        function addPreview(container, file, isLoading, onDelete) {
            const item = document.createElement('div');
            item.className = 'preview-item';
            const img = document.createElement('img');
            const reader = new FileReader();
            reader.onload = e => img.src = e.target.result;
            reader.readAsDataURL(file);
            item.appendChild(img);
            if (isLoading) {
                const spin = document.createElement('div'); spin.className = 'spinner'; spin.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                item.appendChild(spin);
            }
            const del = document.createElement('button');
            del.className = 'delete-preview';
            del.innerHTML = '<i class="fas fa-times"></i>';
            del.onclick = () => { onDelete?.(item); item.remove(); };
            item.appendChild(del);
            container.appendChild(item);
            return item;
        }

        // Product image upload
        const productPreview = document.getElementById('product-image-previews');
        const productHidden = document.getElementById('product-image-urls-hidden');
        const productUpload = document.getElementById('upload-product-images-btn');
        const productInput = document.getElementById('product-image-upload');
        productUpload.addEventListener('click', async () => {
            const files = productInput.files;
            if (!files.length) return showToast('Select images', 'error');
            productUpload.disabled = true;
            const items = [];
            for (let f of files) {
                items.push({ item: addPreview(productPreview, f, true, () => updateProductUrls()), file: f });
            }
            try {
                for (let {item, file} of items) {
                    const url = await uploadToImgBB(file);
                    item.querySelector('img').src = url;
                    item.querySelector('.spinner')?.remove();
                }
                updateProductUrls();
                showToast('Uploaded');
            } catch (e) { showToast('Upload failed', 'error'); }
            productUpload.disabled = false;
            productInput.value = '';
        });
        function updateProductUrls() {
            const urls = [];
            productPreview.querySelectorAll('.preview-item').forEach(item => {
                const img = item.querySelector('img');
                if (img && img.src.startsWith('http')) urls.push(img.src);
            });
            productHidden.value = urls.join(',');
        }

        // Category image upload
        const catPreview = document.getElementById('category-image-preview');
        const catHidden = document.getElementById('category-image-hidden');
        const catUpload = document.getElementById('upload-category-image-btn');
        const catInput = document.getElementById('category-image-upload');
        catUpload.addEventListener('click', async () => {
            const file = catInput.files[0];
            if (!file) return showToast('Select image', 'error');
            catUpload.disabled = true;
            catPreview.innerHTML = '';
            const item = addPreview(catPreview, file, true, () => catHidden.value = '');
            try {
                const url = await uploadToImgBB(file);
                item.querySelector('img').src = url;
                item.querySelector('.spinner')?.remove();
                catHidden.value = url;
                showToast('Uploaded');
            } catch (e) { showToast('Upload failed', 'error'); }
            catUpload.disabled = false;
            catInput.value = '';
        });

        // Open modals for add/edit
        window.openProductModal = (product) => {
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            productPreview.innerHTML = ''; productHidden.value = '';
            document.getElementById('modal-product-title').textContent = 'Add Product';
            if (product) {
                document.getElementById('modal-product-title').textContent = 'Edit Product';
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-description').value = product.description;
                document.getElementById('product-category').value = product.categoryId || '';
                hasVariants.checked = product.hasVariants || false;
                const urls = product.imageUrls || (product.imageUrl ? [product.imageUrl] : []);
                urls.forEach(url => {
                    const item = document.createElement('div');
                    item.className = 'preview-item';
                    item.innerHTML = `<img src="${url}"><button class="delete-preview"><i class="fas fa-times"></i></button>`;
                    item.querySelector('.delete-preview').onclick = () => { item.remove(); updateProductUrls(); };
                    productPreview.appendChild(item);
                });
                productHidden.value = urls.join(',');
                if (product.hasVariants && product.variants) {
                    product.variants.forEach(v => createVariantEntry(v));
                } else {
                    document.getElementById('product-price').value = product.price || '';
                    document.getElementById('product-stock').value = product.stock || '';
                    document.getElementById('product-original-price').value = product.originalPrice || '';
                }
            } else {
                hasVariants.checked = false;
            }
            hasVariants.dispatchEvent(new Event('change'));
            openModal('product-modal');
        };

        window.openCategoryModal = (cat) => {
            document.getElementById('category-form').reset();
            document.getElementById('category-id').value = '';
            catPreview.innerHTML = ''; catHidden.value = '';
            document.getElementById('modal-category-title').textContent = 'Add Category';
            if (cat) {
                document.getElementById('modal-category-title').textContent = 'Edit Category';
                document.getElementById('category-id').value = cat.id;
                document.getElementById('category-name').value = cat.name;
                if (cat.imageUrl) {
                    const item = document.createElement('div');
                    item.className = 'preview-item';
                    item.innerHTML = `<img src="${cat.imageUrl}"><button class="delete-preview"><i class="fas fa-times"></i></button>`;
                    item.querySelector('.delete-preview').onclick = () => { item.remove(); catHidden.value = ''; };
                    catPreview.appendChild(item);
                    catHidden.value = cat.imageUrl;
                }
            }
            openModal('category-modal');
        };

        window.openDiscountModal = (disc) => {
            document.getElementById('discount-form').reset();
            document.getElementById('discount-id').value = '';
            document.getElementById('modal-discount-title').textContent = 'Add Discount';
            document.getElementById('max-discount-group').classList.add('d-none');
            if (disc) {
                document.getElementById('modal-discount-title').textContent = 'Edit Discount';
                document.getElementById('discount-id').value = disc.id;
                document.getElementById('discount-code').value = disc.code;
                document.getElementById('discount-type').value = disc.type;
                document.getElementById('discount-value').value = disc.value;
                if (disc.type === 'percent') {
                    document.getElementById('max-discount-group').classList.remove('d-none');
                    document.getElementById('discount-max').value = disc.max || '';
                }
            }
            openModal('discount-modal');
        };

        window.openOrderDetailsModal = (orderId) => {
            const o = currentOrders[orderId];
            if (!o) return;
            const d = o.shippingDetails || {};
            document.getElementById('detail-customer-name').textContent = d.name || 'N/A';
            document.getElementById('detail-customer-phone').textContent = d.phone || 'N/A';
            document.getElementById('detail-customer-address').textContent = d.fullAddress || 'N/A';
            document.getElementById('detail-customer-city').textContent = d.city || 'N/A';
            document.getElementById('detail-customer-pincode').textContent = d.pincode || 'N/A';
            document.getElementById('detail-order-id').textContent = generateNumericOrderId(orderId);
            document.getElementById('detail-order-date').textContent = formatDateTime(o.date);
            document.getElementById('detail-order-discount').textContent = o.discountCode || 'None';
            const items = Object.values(o.items || {});
            document.getElementById('order-details-products').innerHTML = items.map(item => `
                <div class="product-card">
                    <img src="${(item.imageUrls && item.imageUrls[0]) || item.imageUrl || ''}" class="product-img">
                    <div class="product-details">
                        <h4>${item.name}${item.selectedVariantName ? ` (${item.selectedVariantName})` : ''}</h4>
                        <div>Qty: ${item.quantity} x ${formatCurrency(item.price)}</div>
                        <div class="product-price">${formatCurrency(item.price * item.quantity)}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('detail-order-subtotal').textContent = formatCurrency(o.subtotal);
            document.getElementById('detail-order-discount-amount').textContent = `-${formatCurrency(o.discount)}`;
            document.getElementById('detail-order-delivery').textContent = formatCurrency(o.deliveryFee);
            document.getElementById('detail-order-total').textContent = formatCurrency(o.total);
            document.getElementById('detail-order-status-select').value = o.status;
            document.getElementById('update-status-btn').dataset.orderId = orderId;
            openModal('order-details-modal');
        };

        // CRUD helper
        const performCRUD = async (path, id, data, action) => {
            try {
                if (action === 'delete') await remove(ref(db, `${path}/${id}`));
                else if (action === 'add') await set(push(ref(db, path)), data);
                else await set(ref(db, `${path}/${id}`), data);
                showToast(`${path.slice(0,-1)} ${action==='delete'?'deleted':id?'updated':'added'}!`);
                return true;
            } catch (e) { showToast('Error: '+e.message, 'error'); return false; }
        };

        // Event listeners for buttons
        document.getElementById('add-product-btn').addEventListener('click', () => openProductModal());
        document.getElementById('products-list').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.classList.contains('btn-edit')) openProductModal({ id, ...currentProducts[id] });
            if (btn.classList.contains('btn-delete') && confirm('Delete?')) performCRUD('products', id, null, 'delete');
        });

        document.getElementById('add-category-btn').addEventListener('click', () => openCategoryModal());
        document.getElementById('categories-list').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.classList.contains('btn-edit')) openCategoryModal({ id, ...currentCategories[id] });
            if (btn.classList.contains('btn-delete') && confirm('Delete category?')) performCRUD('categories', id, null, 'delete');
        });

        document.getElementById('add-discount-btn').addEventListener('click', () => openDiscountModal());
        document.getElementById('discounts-list').addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            if (btn.classList.contains('btn-edit')) openDiscountModal({ id, ...currentDiscounts[id] });
            if (btn.classList.contains('btn-delete') && confirm('Delete discount?')) performCRUD('discounts', id, null, 'delete');
        });

        document.getElementById('orders-list').addEventListener('click', (e) => {
            const btn = e.target.closest('button.btn-view');
            if (btn) openOrderDetailsModal(btn.dataset.id);
        });

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const cat = document.getElementById('product-category').value;
            if (!cat) return showToast('Select category', 'error');
            const id = document.getElementById('product-id').value;
            const imageUrls = productHidden.value.split(',').filter(u => u);
            if (!imageUrls.length) return showToast('Upload at least one image', 'error');
            const data = {
                name: document.getElementById('product-name').value,
                imageUrls, imageUrl: imageUrls[0],
                description: document.getElementById('product-description').value,
                categoryId: cat,
                categoryName: document.getElementById('product-category').selectedOptions[0].text,
                hasVariants: hasVariants.checked,
                status: 'approved'
            };
            if (hasVariants.checked) {
                const entries = [...document.querySelectorAll('.variant-entry')];
                if (!entries.length) return showToast('Add at least one variant', 'error');
                data.variants = entries.map(e => ({
                    name: e.querySelector('.variant-name').value,
                    price: parseFloat(e.querySelector('.variant-price').value),
                    originalPrice: parseFloat(e.querySelector('.variant-original-price').value) || null,
                    stock: parseInt(e.querySelector('.variant-stock').value)
                }));
                if (data.variants.some(v => !v.name || isNaN(v.price) || isNaN(v.stock))) return showToast('Fill all variant fields', 'error');
            } else {
                data.price = parseFloat(document.getElementById('product-price').value);
                data.stock = parseInt(document.getElementById('product-stock').value);
                data.originalPrice = parseFloat(document.getElementById('product-original-price').value) || null;
                if (data.originalPrice && data.price >= data.originalPrice) return showToast('Selling price must be less than original', 'error');
            }
            if (await performCRUD('products', id, data, id ? 'update' : 'add')) closeModal('product-modal');
        });

        document.getElementById('category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('category-id').value;
            const url = catHidden.value;
            if (!url) return showToast('Upload image', 'error');
            const data = { name: document.getElementById('category-name').value, imageUrl: url };
            if (await performCRUD('categories', id, data, id ? 'update' : 'add')) closeModal('category-modal');
        });

        document.getElementById('discount-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('discount-id').value;
            const type = document.getElementById('discount-type').value;
            const data = {
                code: document.getElementById('discount-code').value.toUpperCase(),
                type,
                value: parseFloat(document.getElementById('discount-value').value),
                max: type === 'percent' ? parseFloat(document.getElementById('discount-max').value) || null : null
            };
            if (await performCRUD('discounts', id, data, id ? 'update' : 'add')) closeModal('discount-modal');
        });

        document.getElementById('discount-type').addEventListener('change', (e) => {
            document.getElementById('max-discount-group').classList.toggle('d-none', e.target.value !== 'percent');
        });

        document.getElementById('update-status-btn').addEventListener('click', async (e) => {
            const orderId = e.target.dataset.orderId;
            const newStatus = document.getElementById('detail-order-status-select').value;
            try {
                await set(ref(db, `orders/${orderId}/status`), newStatus);
                showToast('Status updated');
                closeModal('order-details-modal');
            } catch (err) { showToast('Update failed', 'error'); }
        });
    </script>
</body>
</html>